<!DOCTYPE html>
<html lang="en">

<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1, user-scalable=no, viewport-fit=cover">
  <title>Group Rooms - Tugwemo</title>
  <link rel="icon" href="public/favicon.ico" type="image/x-icon">
  <link rel="stylesheet" href="public/style.css">
  <link rel="stylesheet" href="public/videostyle.css">
  <script src="./i18n.js"></script>
  <style>
    body {
      overflow-y: auto;
    }
  </style>
</head>

<body>
  <!-- Header -->
  <header class="header">
    <div class="container">
      <div class="header-content">
        <img src="public/Tugwemo.png" alt="Tugwemo Logo" class="header-logo" onclick="window.location.href='/'">
        <nav class="nav">
          <button class="btn back-btn" onclick="window.location.href='/'" data-i18n="nav.backHome">‚Üê Back to Home</button>
        </nav>
      </div>
    </div>
  </header>

  <!-- Group Rooms Section -->
  <section class="group-rooms-section">
    <div class="container">
      <div class="group-rooms-content">
        <h1 class="group-title" data-i18n="group.title">Group Video Chat</h1>
        <p class="group-description" data-i18n="group.description">
          Create a custom room with a unique code and invite up to 6 friends for private video conversations.
          No registration required - just share the code!
        </p>

        <div class="group-options-grid">
          <div class="group-option-card" onclick="showCreateRoomPage()">
            <div class="option-icon">üè†</div>
            <h3 data-i18n="group.createRoom">Create Room</h3>
            <p data-i18n="group.createDesc">Generate a unique room code and start a new group chat</p>
            <button class="btn-primary" data-i18n="group.createRoom">Create Room</button>
          </div>

          <div class="group-option-card" onclick="showJoinRoomPage()">
            <div class="option-icon">üö™</div>
            <h3 data-i18n="group.joinRoom">Join Room</h3>
            <p data-i18n="group.joinDesc">Enter a room code to join an existing group chat</p>
            <button class="btn-secondary" data-i18n="group.joinRoom">Join Room</button>
          </div>
        </div>
      </div>
    </div>
  </section>

  <!-- Footer -->
  <footer class="footer">
    <div class="container">
      <div class="footer-links">
        <a href="terms.html" data-i18n="nav.terms">Terms of Service</a>
        <a href="privacy.html" data-i18n="nav.privacy">Privacy Policy</a>
        <a href="contact.html" data-i18n="nav.contact">Contact Us</a>
      </div>
      <p class="copyright" data-i18n="footer.copyright">2024 Tugwemo. All rights reserved.</p>
    </div>
  </footer>

  <!-- Scripts -->
  <script>
    // Language selection
    function selectLanguage(lang) {
      localStorage.setItem('language', lang);
      i18n.setLanguage(lang);
      document.getElementById('language-modal').style.display = 'none';
      location.reload();
    }

    // Check if language is selected on page load
    window.addEventListener('load', () => {
      const language = localStorage.getItem('language');
      if (!language) {
        document.getElementById('language-modal').style.display = 'flex';
      }

      // Start typing effect
      setTimeout(typeWriter, 1000);
    });

    // Typing effect for tagline
    const typingText = document.getElementById('typing-text');
    const messages = [
      i18n.get('hero.title', 'Connect anonymously.'),
      i18n.get('hero.subtitle', 'Chat freely.'),
      i18n.get('hero.tagline', 'Meet authentically.')
    ];
    let messageIndex = 0;
    let charIndex = 0;
    let isDeleting = false;

    function typeWriter() {
      const currentMessage = messages[messageIndex];

      if (!isDeleting) {
        typingText.textContent = currentMessage.substring(0, charIndex + 1);
        charIndex++;
        if (charIndex === currentMessage.length) {
          isDeleting = true;
          setTimeout(typeWriter, 2000); // Pause at end
          return;
        }
      } else {
        typingText.textContent = currentMessage.substring(0, charIndex - 1);
        charIndex--;
        if (charIndex < 0) {
          isDeleting = false;
          messageIndex = (messageIndex + 1) % messages.length;
          setTimeout(typeWriter, 500); // Pause before next message
          return;
        }
      }

      setTimeout(typeWriter, isDeleting ? 50 : 100);
    }

    function redirect() {
      const token = localStorage.getItem('token');
      const language = localStorage.getItem('language');
      if (!token) {
        if (!language) {
          document.getElementById('language-modal').style.display = 'flex';
        } else {
          window.location.href = '/login.html';
        }
      } else {
        window.location.href = '/video.html';
      }
    }

    function showCreateRoomPage() {
      // Check authentication first
      const token = localStorage.getItem('token');
      if (!token) {
        alert(i18n.get('group.authRequired', 'Authentication required. Please log in to create group rooms.'));
        window.location.href = '/login.html';
        return;
      }

      // Create room creation page/prompt
      const modal = document.createElement('div');
      modal.className = 'modal-overlay';
      modal.innerHTML = `
        <div class="modal-content large-modal">
          <div class="modal-header">
            <h3 data-i18n="group.createModal.title">Create Group Room</h3>
            <button class="modal-close">&times;</button>
          </div>
          <div class="modal-body">
            <div class="form-group">
              <label for="room-code-input" data-i18n="group.createModal.codeLabel">Room Code (3-12 characters)</label>
              <div class="input-group">
                <input type="text" id="room-code-input" data-i18n-placeholder="group.createModal.placeholder" placeholder="Enter room code or generate one" maxlength="12">
                <button id="generate-code-btn" class="btn-secondary" data-i18n="group.createModal.generate">Generate</button>
              </div>
              <small class="form-hint" data-i18n="group.createModal.hint">Share this code with friends to let them join your room</small>
            </div>
            <div id="create-room-error" class="error-message"></div>
            <div id="create-room-success" class="success-message"></div>
          </div>
          <div class="modal-footer">
            <button id="create-room-btn" class="btn-primary" data-i18n="group.createModal.createBtn">Create Room</button>
          </div>
        </div>
      `;
      document.body.appendChild(modal);

      // Add event listeners
      const closeBtn = modal.querySelector('.modal-close');
      const createBtn = modal.querySelector('#create-room-btn');
      const generateBtn = modal.querySelector('#generate-code-btn');

      closeBtn.addEventListener('click', () => modal.remove());
      modal.addEventListener('click', (e) => {
        if (e.target === modal) modal.remove();
      });

      generateBtn.addEventListener('click', () => {
        const input = modal.querySelector('#room-code-input');
        input.value = generateRandomCode();
      });

      createBtn.addEventListener('click', async () => {
        const input = modal.querySelector('#room-code-input');
        const code = input.value.trim();
        if (!code || code.length < 3 || code.length > 12) {
          showModalError(modal, 'Room code must be 3-12 characters');
          return;
        }

        try {
          const backendUrl = window.location.hostname === 'localhost' ? 'http://localhost:8000' : 'https://tugwemo-backend.onrender.com';
          const response = await fetch(`${backendUrl}/api/room/create`, {
            method: 'POST',
            headers: {
              'Content-Type': 'application/json',
              'Authorization': `Bearer ${token}`
            },
            body: JSON.stringify({ roomCode: code })
          });

          const data = await response.json();

          if (response.ok) {
            showModalSuccess(modal, `Room "${data.roomCode}" created successfully!`);
            setTimeout(() => {
              modal.remove();
              // Redirect to group video page with room code
              localStorage.setItem('groupRoomCode', data.roomCode);
              window.location.href = 'group-video.html';
            }, 2000);
          } else {
            showModalError(modal, data.error || 'Failed to create room');
          }
        } catch (error) {
          showModalError(modal, 'Failed to create room');
        }
      });
    }

    function showJoinRoomPage() {
      // Check authentication first
      const token = localStorage.getItem('token');
      if (!token) {
        alert(i18n.get('group.authRequiredJoin', 'Authentication required. Please log in to join group rooms.'));
        window.location.href = '/login.html';
        return;
      }

      // Create room joining page/prompt
      const modal = document.createElement('div');
      modal.className = 'modal-overlay';
      modal.innerHTML = `
        <div class="modal-content large-modal">
          <div class="modal-header">
            <h3 data-i18n="group.joinModal.title">Join Group Room</h3>
            <button class="modal-close">&times;</button>
          </div>
          <div class="modal-body">
            <div class="form-group">
              <label for="join-room-code-input" data-i18n="group.joinModal.codeLabel">Room Code</label>
              <input type="text" id="join-room-code-input" data-i18n-placeholder="group.joinModal.placeholder" placeholder="Enter the room code" maxlength="12">
              <small class="form-hint" data-i18n="group.joinModal.hint">Enter the code shared by the room creator</small>
            </div>
            <div id="join-room-error" class="error-message"></div>
            <div id="join-room-success" class="success-message"></div>
          </div>
          <div class="modal-footer">
            <button id="join-room-btn" class="btn-primary" data-i18n="group.joinModal.joinBtn">Join Room</button>
          </div>
        </div>
      `;
      document.body.appendChild(modal);

      // Add event listeners
      const closeBtn = modal.querySelector('.modal-close');
      const joinBtn = modal.querySelector('#join-room-btn');

      closeBtn.addEventListener('click', () => modal.remove());
      modal.addEventListener('click', (e) => {
        if (e.target === modal) modal.remove();
      });

      joinBtn.addEventListener('click', async () => {
        const input = modal.querySelector('#join-room-code-input');
        const code = input.value.trim();
        if (!code) {
          showModalError(modal, 'Please enter a room code');
          return;
        }

        try {
          const backendUrl = window.location.hostname === 'localhost' ? 'http://localhost:8000' : 'https://tugwemo-backend.onrender.com';
          const response = await fetch(`${backendUrl}/api/room/join`, {
            method: 'POST',
            headers: {
              'Content-Type': 'application/json',
              'Authorization': `Bearer ${token}`
            },
            body: JSON.stringify({ roomCode: code })
          });

          const data = await response.json();

          if (response.ok) {
            showModalSuccess(modal, `Joining room "${data.roomCode}"...`);
            setTimeout(() => {
              modal.remove();
              // Redirect to group video page with room code
              localStorage.setItem('groupRoomCode', data.roomCode);
              window.location.href = 'group-video.html';
            }, 2000);
          } else {
            showModalError(modal, data.error || 'Failed to join room');
          }
        } catch (error) {
          showModalError(modal, 'Failed to join room');
        }
      });
    }

    function generateRandomCode() {
      const chars = 'ABCDEFGHIJKLMNOPQRSTUVWXYZ0123456789';
      let result = '';
      for (let i = 0; i < 6; i++) {
        result += chars.charAt(Math.floor(Math.random() * chars.length));
      }
      return result;
    }

    function showModalError(modal, message) {
      const errorDiv = modal.querySelector('.error-message');
      if (errorDiv) {
        errorDiv.textContent = message;
        errorDiv.style.display = 'block';
        setTimeout(() => errorDiv.style.display = 'none', 5000);
      }
    }

    function showModalSuccess(modal, message) {
      const successDiv = modal.querySelector('.success-message');
      if (successDiv) {
        successDiv.textContent = message;
        successDiv.style.display = 'block';
      }
    }
  </script>

  <style>
    .header {
      background: rgba(255, 255, 255, 0.95);
      backdrop-filter: blur(10px);
      border-bottom: 1px solid rgba(0, 0, 0, 0.1);
      position: sticky;
      top: 0;
      z-index: 1000;
    }

    .header-content {
      display: flex;
      justify-content: space-between;
      align-items: center;
      padding: 1rem 0;
    }

    .header-logo {
      height: 40px;
      cursor: pointer;
    }

    .back-btn {
      background: #f0f0f0;
      color: #333;
      border: none;
      padding: 0.5rem 1rem;
      border-radius: 0.5rem;
      cursor: pointer;
      font-size: 0.9rem;
    }

    .back-btn:hover {
      background: #e0e0e0;
    }

    .footer {
      background: #f8f9fa;
      padding: 2rem 0;
      border-top: 1px solid #e9ecef;
    }

    .group-rooms-section {
      min-height: calc(100vh - 80px);
      padding: 2rem 0;
      background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
    }

    .group-rooms-content {
      max-width: 800px;
      margin: 0 auto;
      text-align: center;
      color: white;
    }

    .group-title {
      font-size: 3rem;
      font-weight: bold;
      margin-bottom: 1rem;
      text-shadow: 2px 2px 4px rgba(0, 0, 0, 0.3);
    }

    .group-description {
      font-size: 1.2rem;
      margin-bottom: 3rem;
      opacity: 0.9;
      line-height: 1.6;
    }

    .group-options-grid {
      display: grid;
      grid-template-columns: repeat(auto-fit, minmax(300px, 1fr));
      gap: 2rem;
      margin-bottom: 3rem;
    }

    .group-option-card {
      background: rgba(255, 255, 255, 0.95);
      backdrop-filter: blur(10px);
      border-radius: 1rem;
      padding: 2rem;
      text-align: center;
      cursor: pointer;
      transition: all 0.3s ease;
      box-shadow: 0 8px 32px rgba(0, 0, 0, 0.1);
    }

    .group-option-card:hover {
      transform: translateY(-5px);
      box-shadow: 0 12px 40px rgba(0, 0, 0, 0.2);
    }

    .option-icon {
      font-size: 3rem;
      margin-bottom: 1rem;
    }

    .group-option-card h3 {
      color: #333;
      font-size: 1.5rem;
      margin-bottom: 0.5rem;
    }

    .group-option-card p {
      color: #666;
      margin-bottom: 1.5rem;
    }

    .group-features {
      display: flex;
      justify-content: center;
      flex-wrap: wrap;
      gap: 2rem;
    }

    .feature {
      display: flex;
      align-items: center;
      gap: 0.5rem;
      background: rgba(255, 255, 255, 0.2);
      padding: 0.5rem 1rem;
      border-radius: 2rem;
      font-size: 0.9rem;
    }

    .feature-icon {
      font-size: 1.2rem;
    }

    /* Modal Styles */
    .modal-overlay {
      position: fixed;
      top: 0;
      left: 0;
      width: 100%;
      height: 100%;
      background: rgba(0, 0, 0, 0.7);
      display: flex;
      justify-content: center;
      align-items: center;
      z-index: 10000;
    }

    .modal-content {
      background: white;
      border-radius: 1rem;
      width: 90%;
      max-width: 500px;
      max-height: 90vh;
      overflow-y: auto;
    }

    .large-modal .modal-content {
      max-width: 600px;
    }

    .modal-header {
      display: flex;
      justify-content: space-between;
      align-items: center;
      padding: 1.5rem;
      border-bottom: 1px solid #eee;
    }

    .modal-header h3 {
      margin: 0;
      color: #333;
    }

    .modal-close {
      background: none;
      border: none;
      font-size: 1.5rem;
      cursor: pointer;
      color: #666;
    }

    .modal-body {
      padding: 1.5rem;
    }

    .form-group {
      margin-bottom: 1.5rem;
      text-align: left;
    }

    .form-group label {
      display: block;
      margin-bottom: 0.5rem;
      font-weight: 500;
      color: #333;
    }

    .form-group input {
      width: 100%;
      padding: 0.75rem;
      border: 1px solid #ddd;
      border-radius: 0.5rem;
      font-size: 1rem;
    }

    .input-group {
      display: flex;
      gap: 0.5rem;
    }

    .input-group input {
      flex: 1;
    }

    .form-hint {
      display: block;
      margin-top: 0.25rem;
      color: #666;
      font-size: 0.9rem;
    }

    .modal-footer {
      padding: 1.5rem;
      border-top: 1px solid #eee;
      display: flex;
      justify-content: flex-end;
    }

    .error-message {
      color: #e74c3c;
      background: #fdf2f2;
      border: 1px solid #f5c6cb;
      padding: 0.75rem;
      border-radius: 0.5rem;
      margin-top: 1rem;
      display: none;
    }

    .success-message {
      color: #27ae60;
      background: #d5f4e6;
      border: 1px solid #a8e6cf;
      padding: 0.75rem;
      border-radius: 0.5rem;
      margin-top: 1rem;
      display: none;
    }

    .btn-primary, .btn-secondary {
      padding: 0.75rem 1.5rem;
      border: none;
      border-radius: 0.5rem;
      font-size: 1rem;
      cursor: pointer;
      transition: all 0.3s ease;
    }

    .btn-primary {
      background: #667eea;
      color: white;
    }

    .btn-primary:hover {
      background: #5a6fd8;
    }

    .btn-secondary {
      background: #f0f0f0;
      color: #333;
    }

    .btn-secondary:hover {
      background: #e0e0e0;
    }

    @media (max-width: 768px) {
      .group-options-grid {
        grid-template-columns: 1fr;
      }

      .group-title {
        font-size: 2rem;
      }

      .group-features {
        flex-direction: column;
        align-items: center;
      }
    }
  </style>
</body>
</html>
